<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Results | CAAA Legal Intelligence</title>
    
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">
    
    <!-- Navigation -->
    <nav class="glass border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="/" class="flex items-center hover:opacity-80 transition">
                        <i class="fas fa-balance-scale text-primary-600 text-2xl mr-3"></i>
                        <span class="text-2xl font-bold bg-gradient-to-r from-primary-600 to-purple-600 bg-clip-text text-transparent">
                            CAAA Legal Intelligence
                        </span>
                    </a>
                </div>
                <div class="flex items-center">
                    <a href="/" class="text-gray-600 hover:text-primary-600 transition">
                        <i class="fas fa-arrow-left mr-2"></i> Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" x-data="searchResults()" x-init="init()">
        <!-- Full Message Modal -->
        <div x-show="showModal" 
             @click.self="showModal = false"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0"
             class="fixed inset-0 z-50 overflow-y-auto flex items-center justify-center p-4 bg-black bg-opacity-50" 
             style="display: none;">
            
            <!-- Modal Content -->
            <div @click.stop 
                 x-show="showModal"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 transform scale-95"
                 x-transition:enter-end="opacity-100 transform scale-100"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100 transform scale-100"
                 x-transition:leave-end="opacity-0 transform scale-95"
                 class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                
                <!-- Modal Header -->
                <div class="bg-gradient-to-r from-primary-600 to-primary-700 px-6 py-4 flex items-center justify-between">
                    <h3 class="text-xl font-bold text-white" x-text="modalMessage?.subject || 'Message'"></h3>
                    <button @click="showModal = false" class="text-white hover:text-gray-200 transition">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <!-- Modal Body -->
                <div class="overflow-y-auto flex-1 p-6">
                    <template x-if="modalMessage">
                        <div>
                            <!-- Message Metadata -->
                            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-xs font-semibold text-gray-600 uppercase mb-1">From</p>
                                        <p class="text-sm text-gray-900" x-text="modalMessage.from_name"></p>
                                    </div>
                                    <div>
                                        <p class="text-xs font-semibold text-gray-600 uppercase mb-1">Date</p>
                                        <p class="text-sm text-gray-900" x-text="modalMessage.post_date"></p>
                                    </div>
                                    <div>
                                        <p class="text-xs font-semibold text-gray-600 uppercase mb-1">Message ID</p>
                                        <p class="text-sm text-gray-900" x-text="modalMessage.caaa_message_id"></p>
                                    </div>
                                    <div x-show="modalMessage.confidence_score">
                                        <p class="text-xs font-semibold text-gray-600 uppercase mb-1">AI Confidence</p>
                                        <p class="text-sm font-bold" 
                                           :class="modalMessage.confidence_score >= 0.8 ? 'text-green-600' : (modalMessage.confidence_score >= 0.6 ? 'text-blue-600' : 'text-yellow-600')"
                                           x-text="Math.round(modalMessage.confidence_score * 100) + '%'"></p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- AI Reasoning -->
                            <div x-show="modalMessage.ai_reasoning" class="bg-blue-50 border-l-4 border-primary-500 p-4 rounded mb-6">
                                <div class="flex items-start">
                                    <i class="fas fa-robot text-primary-600 mt-1 mr-3"></i>
                                    <div>
                                        <p class="text-sm font-semibold text-gray-900 mb-1">AI Analysis:</p>
                                        <p class="text-sm text-gray-700" x-text="modalMessage.ai_reasoning"></p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Full Message Body -->
                            <div class="prose prose-sm max-w-none">
                                <h4 class="text-sm font-semibold text-gray-600 uppercase mb-3">Full Message:</h4>
                                <div class="text-gray-800 whitespace-pre-wrap bg-gray-50 p-4 rounded border text-sm" x-text="modalMessage.body"></div>
                            </div>
                        </div>
                    </template>
                </div>
                
                <!-- Modal Footer -->
                <div class="bg-gray-50 px-6 py-4 flex justify-end border-t">
                    <button @click="showModal = false" 
                            class="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg font-medium transition">
                        Close
                    </button>
                </div>
            </div>
        </div>

        
        <!-- Search Header -->
        <div class="glass rounded-xl p-8 mb-8">
            <div class="flex items-start justify-between mb-6">
                <div class="flex-1">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2" x-text="searchData?.keyword || 'Search Results'"></h1>
                    <div class="flex items-center space-x-4 text-sm text-gray-600">
                        <span>
                            <i class="fas fa-calendar text-gray-400 mr-1"></i>
                            <span x-text="searchData?.created_at || 'N/A'"></span>
                        </span>
                        <span class="px-3 py-1 rounded-full font-semibold"
                              :class="{
                                  'bg-green-100 text-green-700': searchData?.status === 'completed',
                                  'bg-yellow-100 text-yellow-700': searchData?.status === 'running',
                                  'bg-red-100 text-red-700': searchData?.status === 'failed',
                                  'bg-gray-100 text-gray-700': !searchData?.status || (searchData?.status !== 'completed' && searchData?.status !== 'running' && searchData?.status !== 'failed')
                              }">
                            <i class="fas fa-circle text-xs mr-1"></i>
                            <span x-text="searchData?.status?.toUpperCase() || 'UNKNOWN'"></span>
                        </span>
                    </div>
                </div>
                
                <button 
                    x-show="searchData?.status === 'running'"
                    @click="refreshStatus"
                    :disabled="refreshing"
                    class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas mr-2" :class="refreshing ? 'fa-spinner fa-spin' : 'fa-sync-alt'"></i>
                    <span x-text="refreshing ? 'Refreshing...' : 'Refresh Status'"></span>
                </button>
            </div>
            
            <!-- Stats -->
            <div class="grid grid-cols-3 gap-6">
                <div class="text-center p-4 bg-blue-50 rounded-lg">
                    <div class="text-3xl font-bold text-primary-600" x-text="stats?.total_messages_found || 0"></div>
                    <div class="text-sm text-gray-600 font-medium mt-1">Messages Found</div>
                </div>
                <div class="text-center p-4 bg-purple-50 rounded-lg">
                    <div class="text-3xl font-bold text-purple-600" x-text="stats?.analyzed_count || 0"></div>
                    <div class="text-sm text-gray-600 font-medium mt-1">Analyzed by AI</div>
                </div>
                <div class="text-center p-4 bg-green-50 rounded-lg">
                    <div class="text-3xl font-bold text-green-600" x-text="stats?.total_relevant_found || 0"></div>
                    <div class="text-sm text-gray-600 font-medium mt-1">
                        Relevant Results
                        <span x-show="stats?.avg_confidence" class="text-xs">
                            (<span x-text="Math.round((stats?.avg_confidence || 0) * 100)"></span>% avg confidence)
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Evaluation Synthesis (if available) -->
        <div x-show="synthesis" class="glass rounded-xl p-8 mb-8 border-4" 
             :class="{
                 'border-primary-500': isAmeQmeSearch(),
                 'border-green-500': !isAmeQmeSearch() && synthesis?.score >= 60,
                 'border-yellow-500': !isAmeQmeSearch() && synthesis?.score >= 40 && synthesis?.score < 60,
                 'border-red-500': !isAmeQmeSearch() && synthesis?.score < 40
             }">
            
            <!-- Standard Evaluation Header (not for AME/QME) -->
            <div x-show="!isAmeQmeSearch()" class="flex items-start justify-between mb-6">
                <div class="flex-1">
                    <h2 class="text-3xl font-bold text-gray-900 mb-2 flex items-center">
                        <i class="fas mr-3 text-primary-600" :class="getEvaluationIcon()"></i>
                        <span x-text="getEvaluationTitle()"></span>
                    </h2>
                    <p class="text-gray-600" x-text="'Evaluation for ' + getEvaluatedName()"></p>
                </div>
                
                <!-- Score Badge -->
                <div class="text-center px-6 py-4 rounded-xl font-bold text-4xl"
                     :class="{
                         'bg-green-100 text-green-700': synthesis?.score >= 60,
                         'bg-yellow-100 text-yellow-700': synthesis?.score >= 40 && synthesis?.score < 60,
                         'bg-red-100 text-red-700': synthesis?.score < 40
                     }">
                    <div x-text="synthesis?.score || 0"></div>
                    <div class="text-xs font-normal mt-1">/ 100</div>
                </div>
            </div>
            
            <!-- AME/QME Search Header -->
            <div x-show="isAmeQmeSearch()" class="mb-6">
                <h2 class="text-3xl font-bold text-gray-900 mb-2 flex items-center">
                    <i class="fas fa-list-ol mr-3 text-primary-600"></i>
                    <span x-text="getEvaluationTitle()"></span>
                </h2>
                <p class="text-gray-600" x-text="'Searching for best ' + getEvaluatedName()"></p>
            </div>
            
            <!-- AME/QME Ranked Doctor List -->
            <div x-show="isAmeQmeSearch() && synthesis?.doctors?.length > 0" class="mb-6">
                <div class="space-y-4">
                    <template x-for="(doctor, index) in synthesis?.doctors || []" :key="index">
                        <div class="bg-white rounded-lg p-5 border-2 border-gray-200 hover:border-primary-300 transition-all">
                            <div class="flex items-start justify-between">
                                <div class="flex items-center gap-4">
                                    <div class="flex items-center justify-center w-10 h-10 rounded-full font-bold text-lg"
                                         :class="{
                                             'bg-yellow-400 text-yellow-900': index === 0,
                                             'bg-gray-300 text-gray-700': index === 1,
                                             'bg-orange-300 text-orange-800': index === 2,
                                             'bg-gray-100 text-gray-600': index > 2
                                         }">
                                        <span x-text="index + 1"></span>
                                    </div>
                                    <div>
                                        <h3 class="text-xl font-bold text-gray-900" x-text="doctor.name"></h3>
                                        <div class="flex items-center gap-4 text-sm text-gray-600 mt-1">
                                            <span class="flex items-center gap-1">
                                                <i class="fas fa-thumbs-up text-green-500"></i>
                                                <span x-text="doctor.positive_mentions + ' positive'"></span>
                                            </span>
                                            <span x-show="doctor.negative_mentions > 0" class="flex items-center gap-1">
                                                <i class="fas fa-thumbs-down text-red-500"></i>
                                                <span x-text="doctor.negative_mentions + ' negative'"></span>
                                            </span>
                                            <span x-show="doctor.specialty_confirmed" class="flex items-center gap-1 text-primary-600">
                                                <i class="fas fa-check-circle"></i>
                                                Specialty confirmed
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold" 
                                         :class="doctor.net_score >= 0 ? 'text-green-600' : 'text-red-600'"
                                         x-text="(doctor.net_score >= 0 ? '+' : '') + doctor.net_score"></div>
                                    <div class="text-xs text-gray-500">net score</div>
                                </div>
                            </div>
                            
                            <!-- Sample Quotes -->
                            <div x-show="doctor.sample_quotes?.length > 0" class="mt-4 space-y-2">
                                <template x-for="(quote, qi) in doctor.sample_quotes?.slice(0, 2) || []" :key="qi">
                                    <div class="bg-gray-50 rounded p-3 text-sm text-gray-700 italic border-l-4 border-primary-300">
                                        "<span x-text="quote"></span>"
                                    </div>
                                </template>
                            </div>
                            
                            <!-- Warnings -->
                            <div x-show="doctor.warnings?.length > 0" class="mt-3">
                                <template x-for="(warning, wi) in doctor.warnings || []" :key="wi">
                                    <div class="bg-red-50 rounded p-2 text-sm text-red-700 flex items-center gap-2">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <span x-text="warning"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
            
            <!-- No doctors found message for AME/QME -->
            <div x-show="isAmeQmeSearch() && (!synthesis?.doctors || synthesis?.doctors?.length === 0)" class="mb-6">
                <div class="bg-yellow-50 rounded-lg p-6 text-center">
                    <i class="fas fa-search text-4xl text-yellow-500 mb-3"></i>
                    <h3 class="text-xl font-semibold text-yellow-800 mb-2">No Doctor Recommendations Found</h3>
                    <p class="text-yellow-700">The search didn't find specific doctor recommendations in the messages. Try adjusting the specialty or increasing the number of messages to search.</p>
                </div>
            </div>
            
            <!-- Evaluation Badge (not for AME/QME) -->
            <div x-show="!isAmeQmeSearch()" class="mb-6">
                <span class="px-4 py-2 rounded-full font-semibold text-lg"
                      :class="{
                          'bg-green-100 text-green-700': synthesis?.evaluation === 'good' || synthesis?.evaluation === 'easy_to_deal_with',
                          'bg-yellow-100 text-yellow-700': synthesis?.evaluation === 'mixed' || synthesis?.evaluation === 'moderate',
                          'bg-red-100 text-red-700': synthesis?.evaluation === 'bad' || synthesis?.evaluation === 'difficult_to_deal_with',
                          'bg-gray-100 text-gray-700': synthesis?.evaluation === 'error' || synthesis?.evaluation === 'unknown' || synthesis?.evaluation === 'insufficient_data'
                      }">
                    <i class="fas mr-2" 
                       :class="{
                           'fa-check-circle': synthesis?.evaluation === 'good' || synthesis?.evaluation === 'easy_to_deal_with',
                           'fa-exclamation-triangle': synthesis?.evaluation === 'mixed' || synthesis?.evaluation === 'moderate',
                           'fa-times-circle': synthesis?.evaluation === 'bad' || synthesis?.evaluation === 'difficult_to_deal_with',
                           'fa-question-circle': synthesis?.evaluation === 'error' || synthesis?.evaluation === 'unknown' || synthesis?.evaluation === 'insufficient_data'
                       }"></i>
                    <span x-text="formatEvaluation(synthesis?.evaluation)"></span>
                </span>
            </div>
            
            <!-- Reasoning / Summary -->
            <div class="bg-gray-50 rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-3">
                    <i class="fas mr-2 text-primary-600" :class="isAmeQmeSearch() ? 'fa-info-circle' : 'fa-brain'"></i>
                    <span x-text="isAmeQmeSearch() ? 'Summary' : 'Analysis'"></span>
                </h3>
                <div class="prose max-w-none text-gray-700 whitespace-pre-line" x-text="synthesis?.reasoning || 'No reasoning available.'"></div>
            </div>
            
            <!-- Synthesis Feedback -->
            <div class="mt-6 pt-6 border-t border-gray-200">
                <div x-show="!synthesisFeedbackSubmitted" class="space-y-4">
                    <h4 class="text-sm font-semibold text-gray-700">Was this evaluation helpful?</h4>
                    <div class="flex items-center gap-4">
                        <button @click="synthesisFeedbackPositive = true" 
                                class="flex items-center gap-2 px-4 py-2 rounded-lg border-2 transition-all"
                                :class="synthesisFeedbackPositive === true ? 'border-green-500 bg-green-50 text-green-700' : 'border-gray-200 hover:border-green-300'">
                            <i class="fas fa-thumbs-up"></i> Yes
                        </button>
                        <button @click="synthesisFeedbackPositive = false"
                                class="flex items-center gap-2 px-4 py-2 rounded-lg border-2 transition-all"
                                :class="synthesisFeedbackPositive === false ? 'border-red-500 bg-red-50 text-red-700' : 'border-gray-200 hover:border-red-300'">
                            <i class="fas fa-thumbs-down"></i> No
                        </button>
                    </div>
                    <div x-show="synthesisFeedbackPositive !== null">
                        <textarea x-model="synthesisFeedbackComment" 
                                  class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-primary-500 focus:ring-2 focus:ring-primary-100 transition-all resize-none"
                                  rows="2"
                                  placeholder="Optional: Tell us why (helps improve future analyses)..."></textarea>
                        <button @click="submitSynthesisFeedback()"
                                :disabled="synthesisFeedbackSubmitting"
                                class="mt-2 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition disabled:opacity-50">
                            <span x-show="!synthesisFeedbackSubmitting">Submit Feedback</span>
                            <span x-show="synthesisFeedbackSubmitting"><i class="fas fa-spinner fa-spin mr-2"></i>Submitting...</span>
                        </button>
                    </div>
                </div>
                <div x-show="synthesisFeedbackSubmitted" class="bg-gray-50 rounded-lg p-4">
                    <div class="flex items-center gap-2 text-green-600 mb-2">
                        <i class="fas fa-check-circle"></i>
                        <span class="font-medium">Feedback submitted!</span>
                        <span :class="synthesisFeedbackPositive ? 'text-green-600' : 'text-red-500'">
                            <i :class="synthesisFeedbackPositive ? 'fas fa-thumbs-up' : 'fas fa-thumbs-down'"></i>
                            <span x-text="synthesisFeedbackPositive ? 'Helpful' : 'Not helpful'"></span>
                        </span>
                    </div>
                    <div x-show="synthesisFeedbackComment" class="text-gray-600 text-sm italic">
                        "<span x-text="synthesisFeedbackComment"></span>"
                    </div>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div class="glass rounded-xl p-8">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-900">
                    <i class="fas fa-check-circle text-green-500 mr-2"></i>
                    Relevant Results
                </h2>
                
                <div x-show="results && results.length > 0" class="text-sm text-gray-600">
                    Showing <span x-text="results?.length || 0"></span> result<span x-show="results?.length !== 1">s</span>
                </div>
            </div>
            
            <div x-show="searchData?.status === 'running'" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-16 w-16 border-b-4 border-primary-600 mb-4"></div>
                <p class="text-lg text-gray-600 font-medium">Processing your search...</p>
                <p class="text-sm text-gray-500 mt-2">This may take a few minutes</p>
            </div>
            
            <div x-show="results && results.length > 0" class="space-y-6">
                <template x-for="result in results" :key="result.message_id">
                <div class="border-2 rounded-xl p-6 transition-all"
                     :class="{
                         'border-green-300 bg-green-50 hover:border-green-400 hover:shadow-lg': result.is_relevant,
                         'border-red-200 bg-red-50 hover:border-red-300 hover:shadow-md opacity-75': !result.is_relevant
                     }"
                     :data-message-id="result.message_id">
                    
                    <!-- Relevance Badge -->
                    <div class="mb-3">
                        <span x-show="result.is_relevant" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-green-500 text-white">
                            <i class="fas fa-check-circle mr-2"></i>RELEVANT
                        </span>
                        <span x-show="!result.is_relevant" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-red-500 text-white">
                            <i class="fas fa-times-circle mr-2"></i>NOT RELEVANT
                        </span>
                    </div>
                    
                    <!-- Result Header -->
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1">
                            <h3 class="text-xl font-semibold text-gray-900 mb-2" x-text="result.subject"></h3>
                            <div class="flex items-center space-x-4 text-sm text-gray-600">
                                <span>
                                    <i class="fas fa-user text-gray-400 mr-1"></i>
                                    <span x-text="result.from_name"></span>
                                </span>
                                <span>
                                    <i class="fas fa-calendar text-gray-400 mr-1"></i>
                                    <span x-text="result.post_date || 'N/A'"></span>
                                </span>
                                <span x-show="result.listserv">
                                    <i class="fas fa-envelope text-gray-400 mr-1"></i>
                                    <span x-text="result.listserv"></span>
                                </span>
                            </div>
                        </div>
                        
                        <!-- Confidence Badge -->
                        <div x-show="result.confidence" class="ml-4">
                            <div class="px-4 py-2 bg-gradient-to-r text-white rounded-lg font-semibold text-sm"
                                 :class="{
                                     'from-green-500 to-emerald-500': result.confidence >= 0.8,
                                     'from-blue-500 to-cyan-500': result.confidence >= 0.6 && result.confidence < 0.8,
                                     'from-yellow-500 to-orange-500': result.confidence < 0.6
                                 }">
                                <span x-text="Math.round((result.confidence || 0) * 100)"></span>% Match
                            </div>
                        </div>
                    </div>
                    
                    <!-- AI Reasoning -->
                    <div x-show="result.ai_reasoning" class="bg-blue-50 border-l-4 border-primary-500 p-4 rounded mb-4">
                        <div class="flex items-start">
                            <i class="fas fa-robot text-primary-600 mt-1 mr-3"></i>
                            <div>
                                <p class="text-sm font-semibold text-gray-900 mb-1">AI Analysis:</p>
                                <p class="text-sm text-gray-700" x-text="result.ai_reasoning"></p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Message Body -->
                    <div class="prose prose-sm max-w-none">
                        <p class="text-gray-700 whitespace-pre-wrap" x-text="result.body"></p>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="mt-4 pt-4 border-t flex items-center justify-between">
                        <div class="text-xs text-gray-500">
                            Message ID: <span x-text="result.caaa_message_id"></span>
                        </div>
                        <div class="flex items-center gap-4">
                            <!-- Message Feedback -->
                            <div x-show="!getMessageFeedbackState(result.message_id).submitted" class="flex items-center gap-2">
                                <span class="text-xs text-gray-500">Helpful?</span>
                                <button @click="submitMessageFeedback(result.message_id, true)"
                                        :disabled="getMessageFeedbackState(result.message_id).submitting"
                                        class="p-1.5 rounded hover:bg-green-100 text-gray-400 hover:text-green-600 transition">
                                    <i class="fas fa-thumbs-up"></i>
                                </button>
                                <button @click="submitMessageFeedback(result.message_id, false)"
                                        :disabled="getMessageFeedbackState(result.message_id).submitting"
                                        class="p-1.5 rounded hover:bg-red-100 text-gray-400 hover:text-red-600 transition">
                                    <i class="fas fa-thumbs-down"></i>
                                </button>
                            </div>
                            <div x-show="getMessageFeedbackState(result.message_id).submitted" class="flex items-center gap-1 text-xs">
                                <i class="fas fa-check text-green-500"></i>
                                <span class="text-gray-500">Thanks!</span>
                            </div>
                            <button 
                                @click="expandMessage(result.message_id)"
                                class="text-sm text-primary-600 hover:text-primary-700 font-medium">
                                Read Full Message <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
                </template>
            </div>
            
            <div x-show="!loading && (!results || results.length === 0) && searchData?.status !== 'running'" class="text-center py-12 text-gray-500">
                <i class="fas fa-search text-6xl text-gray-300 mb-4"></i>
                <p class="text-lg font-medium">No relevant results found</p>
                <p class="text-sm mt-2">The AI analyzed all messages but none met the relevance threshold for this query.</p>
            </div>
        </div>
    </div>

    <script>
        function searchResults() {
            return {
                searchId: new URLSearchParams(window.location.search).get('id') || window.location.pathname.split('/').pop(),
                searchData: null,
                results: [],
                stats: {},
                synthesis: null,
                loading: true,
                refreshing: false,
                error: null,
                showModal: false,
                modalMessage: null,
                
                // Synthesis feedback state
                synthesisFeedbackPositive: null,
                synthesisFeedbackComment: '',
                synthesisFeedbackSubmitting: false,
                synthesisFeedbackSubmitted: false,
                
                // Message feedback state
                messageFeedback: {},  // keyed by message_id
                
                async init() {
                    await this.fetchResults();
                    // Poll for updates every 3 seconds if search is still running
                    if (this.searchData?.status === 'running') {
                        setInterval(() => this.fetchResults(), 3000);
                    }
                },
                
                async fetchResults() {
                    try {
                        const response = await fetch(`/api/search/${this.searchId}`);
                        const data = await response.json();
                        
                        this.searchData = data.search_info;
                        this.results = data.results || [];
                        this.stats = data.stats || {};
                        this.synthesis = data.synthesis || null;
                        this.loading = false;
                        
                        // Load existing feedback
                        await this.loadExistingFeedback();
                    } catch (err) {
                        this.error = err.message;
                        this.loading = false;
                    }
                },
                
                async loadExistingFeedback() {
                    try {
                        const response = await fetch(`/api/feedback/${this.searchId}`);
                        const data = await response.json();
                        
                        if (data.synthesis_feedback) {
                            this.synthesisFeedbackPositive = data.synthesis_feedback.is_positive;
                            this.synthesisFeedbackComment = data.synthesis_feedback.comment || '';
                            this.synthesisFeedbackSubmitted = true;
                        }
                        
                        if (data.message_feedback && data.message_feedback.length > 0) {
                            data.message_feedback.forEach(fb => {
                                this.messageFeedback[fb.message_id] = {
                                    submitted: true,
                                    isPositive: fb.is_positive
                                };
                            });
                        }
                    } catch (err) {
                        console.log('No existing feedback:', err);
                    }
                },
                
                async refreshStatus() {
                    this.refreshing = true;
                    await this.fetchResults();
                    setTimeout(() => this.refreshing = false, 500);
                },
                
                getEvaluationType() {
                    const aiIntent = this.searchData?.search_params?.ai_intent || '';
                    if (aiIntent.startsWith('Evaluate doctor:')) return 'doctor';
                    if (aiIntent.startsWith('Evaluate judge:')) return 'judge';
                    if (aiIntent.startsWith('Evaluate adjuster:')) return 'adjuster';
                    if (aiIntent.startsWith('Evaluate defense attorney:')) return 'defense_attorney';
                    if (aiIntent.startsWith('Evaluate insurance company:')) return 'insurance_company';
                    if (aiIntent.startsWith('Find best')) return 'ame_qme_search';
                    return 'general';
                },
                
                getEvaluatedName() {
                    const aiIntent = this.searchData?.search_params?.ai_intent || '';
                    if (aiIntent.startsWith('Evaluate doctor:')) return aiIntent.replace('Evaluate doctor:', '').trim();
                    if (aiIntent.startsWith('Evaluate judge:')) return aiIntent.replace('Evaluate judge:', '').trim();
                    if (aiIntent.startsWith('Evaluate adjuster:')) return aiIntent.replace('Evaluate adjuster:', '').trim();
                    if (aiIntent.startsWith('Evaluate defense attorney:')) return aiIntent.replace('Evaluate defense attorney:', '').trim();
                    if (aiIntent.startsWith('Evaluate insurance company:')) return aiIntent.replace('Evaluate insurance company:', '').trim();
                    if (aiIntent.startsWith('Find best')) return aiIntent.replace('Find best', '').trim();
                    return 'Unknown';
                },
                
                getEvaluationTitle() {
                    const type = this.getEvaluationType();
                    if (type === 'doctor') return 'Doctor Evaluation';
                    if (type === 'judge') return 'Judge Evaluation';
                    if (type === 'adjuster') return 'Adjuster Evaluation';
                    if (type === 'defense_attorney') return 'Defense Attorney Evaluation';
                    if (type === 'insurance_company') return 'Insurance Company Evaluation';
                    if (type === 'ame_qme_search') return 'Top Recommended Doctors';
                    return 'Evaluation';
                },
                
                getEvaluationIcon() {
                    const type = this.getEvaluationType();
                    if (type === 'doctor') return 'fa-user-md';
                    if (type === 'judge') return 'fa-gavel';
                    if (type === 'adjuster') return 'fa-clipboard-check';
                    if (type === 'defense_attorney') return 'fa-user-tie';
                    if (type === 'insurance_company') return 'fa-building';
                    if (type === 'ame_qme_search') return 'fa-list-ol';
                    return 'fa-search';
                },
                
                // Check if this is an AME/QME search (for conditional rendering)
                isAmeQmeSearch() {
                    return this.getEvaluationType() === 'ame_qme_search';
                },
                
                formatEvaluation(evaluation) {
                    if (!evaluation) return 'UNKNOWN';
                    // Map defense attorney terminology to display text
                    const displayMap = {
                        'good': 'GOOD',
                        'bad': 'BAD',
                        'mixed': 'MIXED',
                        'easy_to_deal_with': 'EASY TO DEAL WITH',
                        'moderate': 'MODERATE',
                        'difficult_to_deal_with': 'DIFFICULT TO DEAL WITH',
                        'insufficient_data': 'INSUFFICIENT DATA',
                        'error': 'ERROR',
                        'unknown': 'UNKNOWN'
                    };
                    return displayMap[evaluation] || evaluation.toUpperCase().replace(/_/g, ' ');
                },
                
                async submitSynthesisFeedback() {
                    if (this.synthesisFeedbackPositive === null) return;
                    
                    this.synthesisFeedbackSubmitting = true;
                    try {
                        const response = await fetch('/api/feedback/synthesis', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                search_id: this.searchId,
                                is_positive: this.synthesisFeedbackPositive,
                                comment: this.synthesisFeedbackComment || null
                            })
                        });
                        
                        if (response.ok) {
                            this.synthesisFeedbackSubmitted = true;
                        }
                    } catch (err) {
                        console.error('Failed to submit synthesis feedback:', err);
                    } finally {
                        this.synthesisFeedbackSubmitting = false;
                    }
                },
                
                async submitMessageFeedback(messageId, isPositive, comment = null) {
                    const key = messageId;
                    this.messageFeedback[key] = { ...this.messageFeedback[key], submitting: true };
                    
                    try {
                        const response = await fetch('/api/feedback/message', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                search_id: this.searchId,
                                message_id: messageId,
                                is_positive: isPositive,
                                comment: comment
                            })
                        });
                        
                        if (response.ok) {
                            this.messageFeedback[key] = { submitted: true, isPositive };
                        }
                    } catch (err) {
                        console.error('Failed to submit message feedback:', err);
                    }
                },
                
                getMessageFeedbackState(messageId) {
                    return this.messageFeedback[messageId] || { submitted: false, isPositive: null, submitting: false };
                },
                
                expandMessage(messageId) {
                    // Find the message card
                    const messageCard = document.querySelector(`[data-message-id="${messageId}"]`);
                    if (!messageCard) {
                        console.error('Message not found:', messageId);
                        return;
                    }
                    
                    // Extract message data from DOM
                    this.modalMessage = {
                        message_id: messageId,
                        subject: messageCard.querySelector('h3')?.textContent || 'No subject',
                        from_name: messageCard.querySelector('.fa-user')?.parentElement?.textContent.trim() || 'Unknown',
                        post_date: messageCard.querySelector('.fa-calendar')?.parentElement?.textContent.trim() || 'N/A',
                        caaa_message_id: messageCard.querySelector('.text-xs.text-gray-500')?.textContent.replace('Message ID: ', '') || 'N/A',
                        confidence_score: parseFloat(messageCard.querySelector('[class*="Match"]')?.textContent) / 100 || null,
                        ai_reasoning: messageCard.querySelector('.bg-blue-50 .text-gray-700')?.textContent || null,
                        body: messageCard.querySelector('.prose p')?.textContent || 'Content not available',
                        is_relevant: messageCard.classList.contains('border-green-300')
                    };
                    
                    this.showModal = true;
                }
            }
        }
    </script>
</body>
</html>

